<?php
namespace App\Controller;
use App\Entity\Livres;
use App\Repository\LivresRepository;
use App\Repository\CategorieRepository;
use Doctrine\ORM\EntityManagerInterface;
use Knp\Component\Pager\PaginatorInterface;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Attribute\Route;
use Symfony\Component\HttpFoundation\Session\SessionInterface;

class VitrineLivresController extends AbstractController
{
    #[Route('/boutique/livres', name: 'app_boutique_livres')]
    public function index(
        LivresRepository $livresRepository,
        CategorieRepository $categorieRepository,
        PaginatorInterface $paginator,
        Request $request
    ): Response {
        // Récupérer les paramètres de recherche
        $search = $request->query->get('search', '');
        $categorieId = $request->query->get('categorie');

        // Préparer la requête
        $query = $livresRepository->createQueryBuilder('l');

        // Appliquer le filtre de recherche par titre
        if ($search) {
            $query->andWhere('l.titre LIKE :search OR l.editeur LIKE :search OR l.resume LIKE :search')
                ->setParameter('search', '%' . $search . '%');
        }

        // Appliquer le filtre par catégorie
        if ($categorieId) {
            $query->andWhere('l.Categorie = :categorieId')
                ->setParameter('categorieId', $categorieId);
        }

        // Paginer les résultats avec KnpPaginator et gestion du tri
        $livres = $paginator->paginate(
            $query,
            $request->query->getInt('page', 1),
            12, // Nombre de livres par page
            [
                'defaultSortFieldName' => 'l.titre',
                'defaultSortDirection' => 'asc',
                'sortFieldWhitelist' => ['l.titre', 'l.prix', 'l.dateEdition']
            ]
        );

        // Récupérer toutes les catégories pour le filtre
        $categories = $categorieRepository->findAll();

        return $this->render('vitrine/livres/index.html.twig', [
            'livres' => $livres,
            'categories' => $categories,
            'currentSearch' => $search,
            'currentCategorie' => $categorieId
        ]);
    }


    #[Route('/boutique/livre/{id}', name: 'app_boutique_livre_show')]
    public function show(Livres $livre): Response
    {
        return $this->render('vitrine/livres/show.html.twig', [
            'livre' => $livre
        ]);
    }

    #[Route('/panier/ajouter/{id}', name: 'app_panier_ajouter')]
    public function ajouterAuPanier(
        Livres $livre,
        Request $request,
        SessionInterface $session
    ): Response {
        // Récupérer le panier actuel de la session
        $panier = $session->get('panier', []);

        // Récupérer la quantité depuis le formulaire
        $quantite = $request->request->get('quantite', 1);

        // Si le livre est déjà dans le panier, augmenter la quantité
        if (isset($panier[$livre->getId()])) {
            $panier[$livre->getId()]['quantite'] += $quantite;
        } else {
            // Sinon, ajouter le livre au panier
            $panier[$livre->getId()] = [
                'id' => $livre->getId(),
                'titre' => $livre->getTitre(),
                'prix' => $livre->getPrix(),
                'image' => $livre->getImage(),
                'quantite' => $quantite
            ];
        }

        // Sauvegarder le panier dans la session
        $session->set('panier', $panier);

        $this->addFlash('success', 'Le livre a été ajouté au panier');

        // Rediriger vers la page précédente
        $referer = $request->headers->get('referer');
        return $this->redirect($referer ?: $this->generateUrl('app_boutique_livres'));
    }

    #[Route('/panier', name: 'app_panier')]
    public function panier(SessionInterface $session): Response
    {
        // Récupérer le panier
        $panier = $session->get('panier', []);

        // Calculer le total
        $total = 0;
        foreach ($panier as $item) {
            $total += $item['prix'] * $item['quantite'];
        }

        return $this->render('vitrine/panier/index.html.twig', [
            'items' => $panier,
            'total' => $total
        ]);
    }

    #[Route('/panier/supprimer/{id}', name: 'app_panier_supprimer')]
    public function supprimerDuPanier(int $id, SessionInterface $session): Response
    {
        // Récupérer le panier
        $panier = $session->get('panier', []);

        // Supprimer l'élément s'il existe
        if (isset($panier[$id])) {
            unset($panier[$id]);
        }

        // Mettre à jour le panier
        $session->set('panier', $panier);

        $this->addFlash('success', 'Le livre a été supprimé du panier');

        return $this->redirectToRoute('app_panier');
    }

    #[Route('/panier/mettre-a-jour/{id}', name: 'app_panier_maj', methods: ['POST'])]
    public function mettreAJourQuantite(
        int $id,
        Request $request,
        SessionInterface $session
    ): Response {
        // Récupérer le panier
        $panier = $session->get('panier', []);

        // Récupérer la nouvelle quantité
        $quantite = $request->request->get('quantite', 1);

        // Mettre à jour la quantité si l'élément existe
        if (isset($panier[$id])) {
            $panier[$id]['quantite'] = max(1, (int)$quantite);
        }

        // Mettre à jour le panier
        $session->set('panier', $panier);

        $this->addFlash('success', 'La quantité a été mise à jour');

        return $this->redirectToRoute('app_panier');
    }

    #[Route('/panier/vider', name: 'app_panier_vider')]
    public function viderPanier(SessionInterface $session): Response
    {
        // Supprimer le panier
        $session->remove('panier');

        $this->addFlash('success', 'Le panier a été vidé');

        return $this->redirectToRoute('app_panier');
    }
}
